name: python-flask app deployment

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: deployment on EC2 instance

    

    steps:
      - name: checkout current branch
      - uses: actions/checkout@v2

      - name: Set up SSH key and whitelist EC2 IP address 🐻‍❄️
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.EC2_IP_ADDRESS }} >> ~/.ssh/known_hosts

      - name: Create .env file dynamically 🧨
        env:
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ENV=${ENV}" >> env
          echo "EC2_USERNAME=${EC2_USERNAME}" >> env

      - name: Copy files to remote server 🚙
        env:
          EC2_HOST: ${{ secrets.EC2_IP_ADDRESS }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          scp -r * $EC2_USERNAME@$EC2_IP_ADDRESS:/home/ubuntu/

      - name: Run Bash Script To Delpoy App 🚀
        env:
          EC2_IP_ADDRESS: ${{ secrets.EC2_IP_ADDRESS }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_IP_ADDRESS '
              cd /home/ubuntu/ && 
              rm -rf personal-portfolio-backend-fe78 &&
              mkdir -r app_files/images
              git clone https://github.com/williamfisher9/personal-portfolio-backend-fe78
              cd personal-portfolio-backend-fe78
              git checkout master &&
              git reset --hard origin/master &&
              git pull origin master &&
              python3 -m venv venv
              source venv/bin/activate
              pip install -r requirements.txt
              python3 -m src
              '